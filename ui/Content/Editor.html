<!DOCTYPE html>
<html>
<head>
    <style type="text/css">
        .red {
            background-color: #f59999;
            background-color: rgba(245, 11, 11, 0.71)
        }
    </style>
     <link href="jquery-ui-1.9.1.custom.css" rel="stylesheet">
</head>
<body>
  
<label>filter Projects <input type="text" data-bind="value:projfilter, valueUpdate: 'afterkeydown'"></label>
    <br> <label>filter References <input type="text" data-bind="value:reffilter, valueUpdate: 'afterkeydown'"></label>
    autocomplete: <input id="auto" data-bind="jqAuto: { autoFocus: true }, jqAutoSource: allRefs, jqAutoValue: reffilter,  jqAutoSourceValue: 'refSimple'" />
<br>
<label>multieditor <input type="checkbox" data-bind="checked: multieditor"> </label>
<br> <input type="button"  data-bind="click:submitUpdates" value="Submit changes" >

<table>
    <tbody data-bind="foreach: refs">
    <tr>
        <td data-bind="text:shortName"></td>

        <!-- ko ifnot: editMode() -->
        <td data-bind="text:ref, click:edit ,css:{red:!fileExists}"></td>
        <!-- /ko -->
        <!-- ko if: editMode() -->
        <td > 
            <input type="text" size="80" data-bind=" jqAuto: { autoFocus: true }, jqAutoSource: $parent.libs, jqAutoValue: ref,  jqAutoSourceValue: 'Name'" />
        </td>
        <!-- /ko -->
       
    </tr>
    </tbody>

</table>


<script type="text/javascript"
        src="../Scripts/knockout-2.2.0.debug.js"></script>

<script type="text/javascript" src="../Scripts/jquery-1.8.2.js"></script>
<script type="text/javascript" src="underscore.js"></script>
<script type="text/javascript" src="underscore.string.js"></script>
     <script type="text/javascript" src="../Scripts/utils.js"></script> 
     <script type="text/javascript" src="../Scripts/knockout-autocomplete.js"></script> 
    <script type="text/javascript" src="../Scripts/jquery-ui-1.9.1.custom.js"></script>
     <script type="text/javascript">

    var MyData = function (actionUrl) {
        var self = this;
        this.projfilter = ko.observable("");
        this.reffilter = ko.observable("");


        this.allRefs = ko.observableArray();

        this.libs = ko.observableArray();

        this.refs = ko.computed(function () {

            console.log("Filter using ", self.projfilter(), self.reffilter());

            return _.filter(self.allRefs(),function (aRef) {
                return _.str.isBlank(self.projfilter()) || _.str.contains(aRef.name, self.projfilter());
            }).filter(function (aRef) {
                        return _.str.isBlank(self.reffilter()) || _.str.contains(aRef.ref(), self.reffilter());
                    });

        });

        this.multieditor=ko.observable(true);

        this.edit = function(ref , value) {
           if (null == value) {
               console.log("Null value supplied");
               return;
           }
            if (self.multieditor()) {
                _.each(self.refs(), function(aRef) { aRef.changeRef(value); });
            } else {
                ref.changeRef(value);
            }
        };

        this.submitUpdates = function() {
            var needUpdate = _.filter(self.allRefs(), function(aRef) {
                return aRef.dirty;
            });


            self.allRefs.removeAll(needUpdate);
            

            needUpdate = _.map(needUpdate, function (aRef) {
                return { ProjectName: aRef.name, newRef: aRef.refSimple(), ref: aRef.loadedValue };
            });
            console.log(ko.toJSON(needUpdate));
            
            $.jsonPost(actionUrl, ko.toJSON(needUpdate), self.populateFromServer, self);
            return false;
        };
        

        this.populateFromServer = function (newRefs) {
            console.log(newRefs.length, "number of elements");
            self.allRefs.push.apply(self.allRefs, _.map(newRefs, function(ref) { return new ProjRef(ref, self); }));
        };
        
        this.populateLibs = function (libs) {
            console.log(libs.length, "number of libs");
            self.libs.push.apply(self.libs, libs);
        };
    };

    var ProjRef = function(serverModel, parent) {
        var self = this;
        this.name = serverModel.ProjectName;
        this.shortName = _.str.strRightBack(serverModel.ProjectName, "\\");
        this.dirty = false;
        this.loadedValue = serverModel.Ref;
        this.refSimple = ko.observable(serverModel.Ref);
        this.fileExists = serverModel.FileExists;
        this.ref = ko.computed({
            read: function() {

                return self.refSimple();
            },
            write: function(newVal) {
                parent.edit(self, newVal);
            }
        });

        this.editMode = ko.observable(false);

        this.edit = function() {
            console.log(self, " was clicked");
            self.editMode(true);
        };

        this.changeRef = function (newVal) {
            console.log("change ref", newVal, self.refSimple(), self.shortName);
            self.refSimple(newVal);
            self.dirty = true;
        };


    };

    var project = "?initialDir=C:\\dragon\\NewsSubmission\\git_dev";

    var actionUrl = "../api/refs" + project;

    var libUrl = "../api/Packages" + project;

    var viewModel = new MyData(actionUrl);
    ko.applyBindings(viewModel);
    
    jQuery.getJSON(actionUrl, function (data) {
       // console.log(data);
        viewModel.populateFromServer(data);
    });

    jQuery.getJSON(libUrl, function (data) {
      //  console.log(data);
        viewModel.populateLibs(data);
    });

</script>

</body>
</html>