<!DOCTYPE html>
<html>
<head>

</head>
<body>

<label>filter Projects <input type="text" data-bind="value:projfilter, valueUpdate: 'afterkeydown'"></label>
<br> <label>filter References <input type="text" data-bind="value:reffilter, valueUpdate: 'afterkeydown'"></label>
<br>
<label>multieditor <input type="checkbox" data-bind="checked: multieditor"> </label>
<br> <input type="button"  data-bind="click:submitUpdates" value="Submit changes" >

<table>
    <tbody data-bind="foreach: refs">
    <tr>
        <td data-bind="text:name"></td>

        <!-- ko ifnot: editMode() -->
        <td data-bind="text:ref, click:edit"></td>
        <!-- /ko -->
        <!-- ko if: editMode() -->
        <td data-bind=""> <input type="text"  data-bind="value:ref, hasfocus:editMode, valueUpdate: 'afterkeydown'" > </td>
        <!-- /ko -->

    </tr>
    </tbody>

</table>


<script type="text/javascript"
        src="../Scripts/knockout-2.2.0.debug.js"></script>

<script type="text/javascript" src="../Scripts/jquery-1.8.2.js"></script>
<script type="text/javascript" src="underscore.js"></script>
<script type="text/javascript" src="underscore.string.js"></script>
<!-- <script type="text/javascript" src="sampledata.js"></script> -->
<script type="text/javascript">

    var MyData = function () {
        var self = this;
        this.projfilter = ko.observable("");
        this.reffilter = ko.observable("");


        this.refsold = ko.observableArray( );

        this.refs = ko.computed(function () {

            console.log("Filter using ", self.projfilter(), self.reffilter());

            return _.filter(self.refsold(),function (aRef) {
                return _.str.isBlank(self.projfilter()) || _.str.contains(aRef.name, self.projfilter());
            }).filter(function (aRef) {
                        return _.str.isBlank(self.reffilter()) || _.str.contains(aRef.ref(), self.reffilter());
                    });

        });

        this.multieditor=ko.observable(true);

        this.edit = function(ref , value){
            ref.changeRef(value)
            if(self.multieditor()){
                _.each(self.refs(), function (aRef) { aRef.changeRef(value); });
            }
        };

        this.submitUpdates = function() {
            var needUpdate = _.filter(self.refs(), function(aRef) {
                return aRef.dirty;
            }).map(function(aRef) {
                 return { name: aRef.name, ref: aRef.refSimple(), oldref: aRef.loadedValue };
            });
            console.log(ko.toJSON(needUpdate));
            return needUpdate;
        };

        this.populateFromServer = function(newRefs) {
            self.refsold.push.apply(self.refsold, _.map(newRefs, function(ref) { return new ProjRef(ref, self); }));

        };
    };

    var ProjRef = function(serverModel, parent) {
        var self = this;
        this.name = serverModel.Name;
        this.dirty = false;
        this.loadedValue = serverModel.Ref;
        this.refSimple = ko.observable(serverModel.Ref);
        this.ref = ko.computed({
            read: function() {

                return self.refSimple();
            },
            write: function(newVal) {
                parent.edit(self, newVal);
            }
        });

        this.editMode = ko.observable(false);

        this.edit = function() {
            console.log(self, " was clicked");
            self.editMode(true);
        };

        this.changeRef = function(newVal) {
            self.refSimple(newVal);
            self.dirty = true;
        };


    };


    var viewModel = new MyData();
    ko.applyBindings(viewModel);


    jQuery.getJSON("../api/refs", function (data) {
        console.log(data);
        viewModel.populateFromServer(data);
    });


</script>

</body>
</html>